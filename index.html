<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>東北雪國多巴胺極限之旅</title>
    <!-- 載入 React 框架 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 載入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Lucide 圖示 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 鎖定畫面高度，防止回彈效果，營造 App 質感 */
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            width: 100%;
            overflow: hidden; 
            background-color: #f8fafc;
            -webkit-font-smoothing: antialiased;
            touch-action: none; /* 防止瀏覽器預設的下拉重整等行為 */
        }
        #root { height: 100%; width: 100%; }
        
        /* 隱藏捲軸但保留功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 地圖操作游標樣式 */
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, className }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const App = () => {
            const [activeDay, setActiveDay] = useState(1);
            
            // --- Bottom Sheet 拖曳邏輯 ---
            const [sheetHeight, setSheetHeight] = useState(45); // 初始高度 45%
            const [isDraggingSheet, setIsDraggingSheet] = useState(false);
            const sheetDragStartY = useRef(0);
            const sheetDragStartHeight = useRef(0);
            const sheetRef = useRef(null); // 修復錯誤：補上 sheetRef 的宣告
            const SNAP_POINTS = [20, 45, 90];

            // --- 地圖縮放與拖曳邏輯 ---
            const [mapTransform, setMapTransform] = useState({ x: 0, y: 0, scale: 1 });
            const [isDraggingMap, setIsDraggingMap] = useState(false);
            const mapDragStart = useRef({ x: 0, y: 0 });
            
            // 地圖操作 Handler
            const handleZoom = (delta) => {
                setMapTransform(prev => {
                    const newScale = Math.min(Math.max(prev.scale + delta, 1), 4); // 限制縮放 1x ~ 4x
                    return { ...prev, scale: newScale };
                });
            };

            const resetMap = () => {
                setMapTransform({ x: 0, y: 0, scale: 1 });
            };

            const handleMapWheel = (e) => {
                // 防止網頁捲動，只縮放地圖
                e.stopPropagation(); 
                const scaleAmount = -e.deltaY * 0.001;
                handleZoom(scaleAmount);
            };

            const handleMapPointerDown = (clientX, clientY) => {
                setIsDraggingMap(true);
                mapDragStart.current = { 
                    x: clientX - mapTransform.x, 
                    y: clientY - mapTransform.y 
                };
            };

            const handleMapPointerMove = (clientX, clientY) => {
                if (!isDraggingMap) return;
                setMapTransform(prev => ({
                    ...prev,
                    x: clientX - mapDragStart.current.x,
                    y: clientY - mapDragStart.current.y
                }));
            };

            const handleMapPointerUp = () => {
                setIsDraggingMap(false);
            };


            // --- Sheet Handler ---
            const handleSheetTouchStart = (e) => {
                setIsDraggingSheet(true);
                sheetDragStartY.current = e.touches[0].clientY;
                sheetDragStartHeight.current = sheetHeight;
            };

            const handleSheetTouchMove = (e) => {
                if (!isDraggingSheet) return;
                const currentY = e.touches[0].clientY;
                const deltaY = currentY - sheetDragStartY.current;
                const windowHeight = window.innerHeight;
                const deltaPercent = (deltaY / windowHeight) * 100;
                
                let newHeight = sheetDragStartHeight.current - deltaPercent;
                if (newHeight < 15) newHeight = 15;
                if (newHeight > 95) newHeight = 95;
                setSheetHeight(newHeight);
            };

            const handleSheetTouchEnd = () => {
                setIsDraggingSheet(false);
                const closest = SNAP_POINTS.reduce((prev, curr) => {
                    return (Math.abs(curr - sheetHeight) < Math.abs(prev - sheetHeight) ? curr : prev);
                });
                setSheetHeight(closest);
            };


            const locations = {
                tpe: { x: 50, y: 750, name: '台北桃園' },
                sdj_air: { x: 340, y: 660, name: '仙台機場', pref: '宮城' },
                sendai: { x: 300, y: 600, name: '仙台市', pref: '宮城' },
                appi: { x: 280, y: 150, name: '安比高原', pref: '岩手' },
                ginzan: { x: 180, y: 400, name: '銀山溫泉', pref: '山形' },
                yamadera: { x: 220, y: 550, name: '山寺', pref: '山形' },
                zao: { x: 180, y: 620, name: '藏王/狐狸村', pref: '宮城/山形' },
            };

            const days = [
                { 
                    day: 1, title: '抵達雪國', path: ['tpe', 'sdj_air', 'appi'], 
                    desc: '桃園飛往仙台，直奔安比高原。享用星宇機上餐，抵達後接駁巴士直達飯店，開啟雪國之夜。', 
                    icon: 'plane', date: '02/01', dinner: '飯店居酒屋 / Room Service'
                },
                { 
                    day: 2, title: '安比燒肉', path: ['appi'], 
                    desc: '早晨岩手優格補充能量，整日征服前山滑道。晚上享用燒肉大餐，補充消耗的熱量。', 
                    icon: 'snowflake', date: '02/02', dinner: '李朝苑 前澤牛燒肉'
                },
                { 
                    day: 3, title: '溫泉修復', path: ['appi'], 
                    desc: '前往西館山滑道避開人潮，午後享受白樺之湯露天溫泉，修復肌肉疲勞。', 
                    icon: 'waves', date: '02/03', dinner: '和食 七時雨 懷石料理'
                },
                { 
                    day: 4, title: '法式慶功', path: ['appi'], 
                    desc: '挑戰長距離滑行，下午雪上摩托車樂園。晚上舉辦慶功宴，享受最後的安比之夜。', 
                    icon: 'party-popper', date: '02/04', dinner: 'Lapin d\'Or 法式料理'
                },
                { 
                    day: 5, title: '移動日', path: ['appi', 'sendai'], 
                    desc: '告別安比，移動至仙台。入住河原町包棟民宿，晚上直奔頂級燒肉名店。', 
                    icon: 'car', date: '02/05', dinner: '米澤牛/仙台牛 燒肉 (仔虎/和火一)'
                },
                { 
                    day: 6, title: '銀山山寺', path: ['sendai', 'yamadera', 'ginzan', 'sendai'], 
                    desc: '挑戰山寺千階雪梯絕景，午後前往銀山溫泉體驗大正浪漫。晚上回仙台品嚐極致口感牛舌。', 
                    icon: 'map-pin', date: '02/06', dinner: '閣 牛舌料理 (必點牛舌刺身)'
                },
                { 
                    day: 7, title: '樹冰狐狸', path: ['sendai', 'zao', 'sendai'], 
                    desc: '包車一日遊：早鳥衝藏王樹冰看雪怪，下午藏王狐狸村抱狐狸。晚上探索在地居酒屋。', 
                    icon: 'camera', date: '02/07', dinner: '仙台商店街 (Happy Road) 居酒屋'
                },
                { 
                    day: 8, title: '完美歸賦', path: ['sendai', 'sdj_air', 'tpe'], 
                    desc: '仙台朝市海鮮丼早餐，仙台城跡巡禮。S-PAL 最後採買伴手禮，帶著滿滿回憶返台。', 
                    icon: 'plane', date: '02/08', dinner: '機上餐 / 溫暖的家'
                },
            ];

            const currentDay = days.find(d => d.day === activeDay);

            return (
                <div className="flex flex-col md:flex-row h-full w-full bg-slate-50 relative overflow-hidden">
                    
                    {/* --- 地圖區域 --- */}
                    <div 
                        className="w-full h-full md:flex-1 bg-white md:m-4 md:mr-0 md:rounded-3xl shadow-sm md:shadow-xl relative z-0 overflow-hidden group pb-[20%] md:pb-0"
                        // 綁定地圖的拖曳與滾輪事件
                        onWheel={handleMapWheel}
                        onMouseDown={(e) => handleMapPointerDown(e.clientX, e.clientY)}
                        onMouseMove={(e) => handleMapPointerMove(e.clientX, e.clientY)}
                        onMouseUp={handleMapPointerUp}
                        onMouseLeave={handleMapPointerUp}
                        onTouchStart={(e) => handleMapPointerDown(e.touches[0].clientX, e.touches[0].clientY)}
                        onTouchMove={(e) => handleMapPointerMove(e.touches[0].clientX, e.touches[0].clientY)}
                        onTouchEnd={handleMapPointerUp}
                    >
                        
                        {/* 標題 (固定不隨地圖移動) */}
                        <div className="absolute top-6 left-6 z-10 pointer-events-none drop-shadow-md">
                            <h2 className="text-2xl font-bold text-slate-800 tracking-tight">多巴胺之旅</h2>
                            <p className="text-slate-500 font-medium text-sm md:text-base">Day {activeDay} • {currentDay.title}</p>
                        </div>

                        {/* 地圖控制按鈕 (固定不隨地圖移動) */}
                        <div className="absolute top-6 right-6 z-10 flex flex-col gap-2">
                            <button onClick={() => handleZoom(0.5)} className="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center text-slate-600 hover:bg-blue-50 hover:text-blue-600 active:scale-95 transition-all">
                                <Icon name="plus" className="w-5 h-5" />
                            </button>
                            <button onClick={() => handleZoom(-0.5)} className="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center text-slate-600 hover:bg-blue-50 hover:text-blue-600 active:scale-95 transition-all">
                                <Icon name="minus" className="w-5 h-5" />
                            </button>
                            <button onClick={resetMap} className="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center text-slate-600 hover:bg-blue-50 hover:text-blue-600 active:scale-95 transition-all" title="重置視野">
                                <Icon name="rotate-ccw" className="w-4 h-4" />
                            </button>
                        </div>

                        {/* SVG 地圖 (可縮放/平移) */}
                        <div 
                            className={`w-full h-full origin-center transition-transform duration-75 ${isDraggingMap ? 'cursor-grabbing' : 'cursor-grab'}`}
                            style={{ 
                                transform: `translate(${mapTransform.x}px, ${mapTransform.y}px) scale(${mapTransform.scale})`,
                            }}
                        >
                            <svg viewBox="0 0 500 800" className="w-full h-full object-cover select-none pointer-events-none" preserveAspectRatio="xMidYMid meet">
                                <defs>
                                    <marker id="arrow" viewBox="0 0 10 10" refX="22" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6" />
                                    </marker>
                                </defs>

                                <path d="M220,100 Q400,50 480,250 T420,600 T300,780 T100,650 T120,200 Z" fill="#f8fafc" stroke="#cbd5e1" strokeWidth="2" />
                                <path d="M120,500 Q300,480 450,520" fill="none" stroke="#e2e8f0" strokeWidth="1.5" strokeDasharray="4" />
                                <text x="380" y="500" className="fill-slate-300 text-[10px]">宮城 / 岩手</text>

                                {days.map((d) => {
                                    if (d.path.length < 2) return null;
                                    return d.path.map((loc, idx) => {
                                        if (idx === 0) return null;
                                        const start = locations[d.path[idx - 1]];
                                        const end = locations[loc];
                                        const isCurrentDay = activeDay === d.day;
                                        
                                        return (
                                            <g key={`path-${d.day}-${idx}`}>
                                                <line x1={start.x} y1={start.y} x2={end.x} y2={end.y} stroke="#f1f5f9" strokeWidth="2" />
                                                <line
                                                    x1={start.x} y1={start.y} x2={end.x} y2={end.y}
                                                    stroke={isCurrentDay ? "#3b82f6" : "transparent"}
                                                    strokeWidth={isCurrentDay ? 4/mapTransform.scale : 4} // 讓線條粗細不隨縮放變太粗
                                                    strokeLinecap="round"
                                                    className="transition-all duration-500"
                                                    strokeDasharray={isCurrentDay ? "5 0" : "0 1000"} 
                                                    markerEnd={isCurrentDay ? "url(#arrow)" : undefined}
                                                />
                                            </g>
                                        );
                                    });
                                })}

                                {Object.entries(locations).map(([key, loc]) => {
                                    const isActive = currentDay.path.includes(key);
                                    return (
                                        <g key={key} className="transition-all duration-300">
                                            {isActive && (
                                                <circle cx={loc.x} cy={loc.y} r="18" fill="#3b82f6" opacity="0.2">
                                                    <animate attributeName="r" from="10" to="25" dur="1.5s" repeatCount="indefinite" />
                                                    <animate attributeName="opacity" from="0.4" to="0" dur="1.5s" repeatCount="indefinite" />
                                                </circle>
                                            )}
                                            <circle cx={loc.x} cy={loc.y} r={isActive ? 8 : 5} fill={isActive ? "#2563eb" : "#94a3b8"} stroke="white" strokeWidth="2" />
                                            <text 
                                                x={loc.x + 14} 
                                                y={loc.y + 5} 
                                                className={`text-[13px] font-bold transition-colors duration-300 ${isActive ? "fill-slate-900" : "fill-slate-400"}`}
                                                // 讓文字大小不隨縮放變太大，稍微做一點補償 (這在 SVG 很難完美，但這招有效)
                                                style={{ fontSize: isActive ? '13px' : '12px' }} 
                                            >
                                                {loc.name}
                                            </text>
                                        </g>
                                    );
                                })}
                            </svg>
                        </div>
                    </div>

                    {/* --- 資訊面板 (可拖曳 Bottom Sheet) --- */}
                    <div 
                        ref={sheetRef}
                        className={`
                            absolute bottom-0 left-0 w-full 
                            bg-white 
                            flex flex-col 
                            rounded-t-[2rem] 
                            shadow-[0_-8px_30px_rgba(0,0,0,0.12)] 
                            z-20 
                            md:relative md:h-auto md:w-[400px] md:mt-4 md:mb-4 md:mr-4 md:ml-0 md:rounded-3xl md:shadow-xl md:!h-auto
                            ${isDraggingSheet ? '' : 'transition-all duration-300 cubic-bezier(0.4, 0, 0.2, 1)'}
                        `}
                        style={{ height: `${sheetHeight}%` }}
                    >
                        
                        {/* 拖曳感應區 (Header) */}
                        <div 
                            className="w-full flex justify-center pt-3 pb-1 md:hidden cursor-grab active:cursor-grabbing touch-none"
                            onTouchStart={handleSheetTouchStart}
                            onTouchMove={handleSheetTouchMove}
                            onTouchEnd={handleSheetTouchEnd}
                        >
                            <div className="w-12 h-1.5 bg-slate-200 rounded-full mb-2"></div>
                        </div>

                        {/* 天數選擇器 */}
                        <div className="px-6 py-2 border-b border-slate-50 shrink-0">
                            <div className="flex gap-3 overflow-x-auto no-scrollbar pb-2 snap-x"
                                 onTouchStart={(e) => e.stopPropagation()} 
                            >
                                {days.map((d) => (
                                    <button
                                        key={d.day} onClick={() => setActiveDay(d.day)}
                                        className={`
                                            flex-shrink-0 snap-center
                                            px-4 py-2 rounded-full text-sm font-bold transition-all border 
                                            ${activeDay === d.day 
                                            ? "bg-blue-600 text-white border-blue-600 shadow-md scale-105" 
                                            : "bg-slate-50 text-slate-400 border-slate-100 hover:border-blue-200"}
                                        `}
                                    >
                                        D{d.day}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* 內容捲動區 */}
                        <div 
                            className="flex-1 overflow-y-auto p-6 pt-2 md:pb-6 overscroll-contain"
                            onTouchStart={(e) => e.stopPropagation()}
                        >
                            <div className="flex justify-between items-start mb-4 mt-2">
                                <div>
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className="px-2 py-0.5 bg-blue-50 text-blue-600 text-[10px] rounded-md font-bold tracking-wider uppercase">
                                            2026/{currentDay.date}
                                        </span>
                                        <span className={`text-[10px] px-2 py-0.5 rounded-md font-bold ${currentDay.path.length > 1 ? 'bg-amber-50 text-amber-600' : 'bg-green-50 text-green-600'}`}>
                                            {currentDay.path.length > 1 ? "移動日" : "定點活動"}
                                        </span>
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-800">{currentDay.title}</h3>
                                </div>
                                <div className="p-2.5 bg-blue-50 text-blue-600 rounded-xl shadow-sm">
                                    <Icon name={currentDay.icon} className="w-5 h-5" />
                                </div>
                            </div>

                            <div className="mb-5">
                                <p className="text-slate-600 leading-relaxed text-sm bg-slate-50 p-4 rounded-xl border border-slate-100">
                                    {currentDay.desc}
                                </p>
                            </div>

                            <div className="mb-6 p-3 bg-orange-50/80 rounded-xl border border-orange-100 flex items-center gap-3">
                                <div className="p-2 bg-white text-orange-500 rounded-lg shadow-sm flex-shrink-0">
                                    <Icon name="utensils" className="w-4 h-4" />
                                </div>
                                <div className="flex-1">
                                    <div className="text-[10px] font-bold text-orange-400 uppercase tracking-wide">Dinner</div>
                                    <div className="text-slate-800 font-bold text-sm truncate">{currentDay.dinner}</div>
                                </div>
                            </div>

                            <div className="space-y-4 pb-20 md:pb-0">
                                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wide flex items-center gap-1">
                                    <Icon name="route" className="w-3 h-3" /> 當日動線
                                </h4>
                                <div className="relative pl-2">
                                    <div className="absolute left-[19px] top-2 bottom-4 w-0.5 bg-slate-200 -z-10"></div>
                                    {currentDay.path.map((locKey, idx) => (
                                        <div key={idx} className="flex items-center gap-4 mb-3 last:mb-0">
                                            <div className="w-9 h-9 rounded-full bg-white border-2 border-slate-200 text-slate-400 flex items-center justify-center text-xs font-bold shadow-sm z-10">
                                                {idx + 1}
                                            </div>
                                            <div className="flex-1 py-2 px-3 rounded-lg border border-slate-50 bg-white shadow-sm flex justify-between items-center">
                                                <div className="text-slate-800 font-bold text-sm">{locations[locKey].name}</div>
                                                <div className="text-slate-400 text-[10px] bg-slate-100 px-2 py-0.5 rounded-full">{locations[locKey].pref || '交通'}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
